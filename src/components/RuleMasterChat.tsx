'use client';

import { useState, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { Send, Bot, User, Lightbulb, BookOpen, ThumbsUp, ThumbsDown, HelpCircle, MessageSquare } from 'lucide-react';
import { ruleMasterService } from '@/lib/rule-master-service';
import { gameTermsService } from '@/lib/game-terms-service';
import { RuleMasterResponse, TermSearchResult } from '@/types/game-terms';
import { YearWarningDisplay, useGameYearInfo } from '@/components/ui/year-warning-display';

interface Message {
    id: string;
    type: 'user' | 'bot';
    content: string;
    timestamp: Date;
    response?: RuleMasterResponse;
    feedback?: UserFeedback;
}

interface UserFeedback {
    type: 'accurate' | 'inaccurate' | 'need_more';
    timestamp: Date;
    comment?: string;
}

interface FeedbackStats {
    totalFeedbacks: number;
    accurateCount: number;
    inaccurateCount: number;
    needMoreCount: number;
    averageConfidence: number;
}

interface AvailableGame {
    id: number;
    name: string;
}

export default function RuleMasterChat() {
    const [messages, setMessages] = useState<Message[]>([]);
    const [input, setInput] = useState('');
    const [selectedGame, setSelectedGame] = useState<number | null>(null);
    const [availableGames, setAvailableGames] = useState<AvailableGame[]>([]);
    const [isLoading, setIsLoading] = useState(false);
    const [feedbackStats, setFeedbackStats] = useState<FeedbackStats>({
        totalFeedbacks: 0,
        accurateCount: 0,
        inaccurateCount: 0,
        needMoreCount: 0,
        averageConfidence: 0
    });
    const [showYearWarning, setShowYearWarning] = useState(false);
    
    // ÏÑ†ÌÉùÎêú Í≤åÏûÑÏùò ÎÖÑÎèÑ Ï†ïÎ≥¥ Ï°∞Ìöå
    const selectedGameName = availableGames.find(g => g.id === selectedGame)?.name || '';
    const yearInfo = useGameYearInfo(selectedGameName);

    useEffect(() => {
        // Ï¥àÍ∏∞Ìôî
        initializeChat();
        // ÌîºÎìúÎ∞± ÌÜµÍ≥Ñ Î°úÎìú
        loadFeedbackStats();
    }, []);

    // ÎÖÑÎèÑ Ï†ïÎ≥¥Í∞Ä Î°úÎìúÎêòÎ©¥ ÏµúÏã† Í≤åÏûÑÏù∏ Í≤ΩÏö∞ Í≤ΩÍ≥† ÌëúÏãú
    useEffect(() => {
        if (yearInfo.isRecentGame && !yearInfo.isLoading) {
            setShowYearWarning(true);
        } else {
            setShowYearWarning(false);
        }
    }, [yearInfo.isRecentGame, yearInfo.isLoading]);

    const initializeChat = async () => {
        // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í≤åÏûÑ Î™©Î°ù Î°úÎî©
        await loadAvailableGames();

        // ÌôòÏòÅ Î©îÏãúÏßÄ
        setMessages([{
            id: '1',
            type: 'bot',
            content: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî Î≥¥ÎìúÍ≤åÏûÑ Î£∞ ÎßàÏä§ÌÑ∞ÏûÖÎãàÎã§. Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Î£∞Ïóê ÎåÄÌï¥ ÏßàÎ¨∏Ìï¥Î≥¥ÏÑ∏Ïöî! üé≤\n\nüí° **ÏÉàÎ°úÏö¥ Í∏∞Îä•**: Ïù¥Ï†ú ÎãµÎ≥ÄÏùò ÎèÑÏõÄ Ï†ïÎèÑÎ•º ÌîºÎìúÎ∞±ÏúºÎ°ú ÏïåÎ†§Ï£ºÏãúÎ©¥ Îçî ÎÇòÏùÄ ÏÑúÎπÑÏä§Î•º Ï†úÍ≥µÌï† Ïàò ÏûàÏäµÎãàÎã§!',
            timestamp: new Date()
        }]);
    };

    const loadAvailableGames = async () => {
        // Í≤åÏûÑ Î™©Î°ùÎßå ÏÑ§Ï†ï (Îç∞Ïù¥ÌÑ∞Îäî ÏÑ†ÌÉùÏãú Î°úÎìú)
        const games: AvailableGame[] = [
            { id: 331, name: 'ÏïÑÌÅ¨ÎÖ∏Î∞î' },
            { id: 1, name: 'ÏÑ∏Î∏êÏõêÎçîÏä§ ÎìÄÏñº' }
        ];

        setAvailableGames(games);
        console.log('‚úÖ [Í≤åÏûÑ Î™©Î°ù Î°úÎìú] Í≤åÏûÑ Î™©Î°ùÎßå Î°úÎìú ÏôÑÎ£å (Îç∞Ïù¥ÌÑ∞Îäî ÏÑ†ÌÉùÏãú Î°úÎìú)');
    };

    /**
     * Í≤åÏûÑÎ≥Ñ Îç∞Ïù¥ÌÑ∞Î•º ÌïÑÏöîÏãúÏóêÎßå Î°úÎìú
     */
    const loadGameDataIfNeeded = async (gameId: number) => {
        try {
            console.log(`üéÆ [Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú] ${gameId}Î≤à Í≤åÏûÑ (${availableGames.find(g => g.id === gameId)?.name}) Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏãúÏûë`);
            await gameTermsService.loadGameTerms(gameId);
            console.log(`‚úÖ [Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú] ${gameId}Î≤à Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏôÑÎ£å`);
        } catch (error) {
            console.warn(`‚ö†Ô∏è [Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®] ${gameId}Î≤à Í≤åÏûÑ:`, error);
        }
    };

    /**
     * Í≤åÏûÑ ÏÑ†ÌÉù Ï≤òÎ¶¨ (Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìè¨Ìï®)
     */
    const handleGameSelection = async (gameId: number | null) => {
        setSelectedGame(gameId);
        
        // Í≤åÏûÑÏù¥ ÏÑ†ÌÉùÎêòÍ≥† Ìï¥Îãπ Í≤åÏûÑÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä ÌïÑÏöîÌïú Í≤ΩÏö∞ Î°úÎìú
        if (gameId && (gameId === 331 || gameId === 1)) {
            await loadGameDataIfNeeded(gameId);
        }
    };

    const loadFeedbackStats = () => {
        // localStorageÏóêÏÑú ÌîºÎìúÎ∞± ÌÜµÍ≥Ñ Î°úÎìú
        const savedStats = localStorage.getItem('rule-master-feedback-stats');
        if (savedStats) {
            setFeedbackStats(JSON.parse(savedStats));
        }
    };

    const saveFeedbackStats = (newStats: FeedbackStats) => {
        localStorage.setItem('rule-master-feedback-stats', JSON.stringify(newStats));
        setFeedbackStats(newStats);
    };

    const handleSendMessage = async () => {
        if (!input.trim()) return;

        const userMessage: Message = {
            id: Date.now().toString(),
            type: 'user',
            content: input.trim(),
            timestamp: new Date()
        };

        setMessages(prev => [...prev, userMessage]);
        setInput('');
        setIsLoading(true);

        try {
            // Î£∞ÎßàÏä§ÌÑ∞ ÎãµÎ≥Ä ÏÉùÏÑ±
            const response = await ruleMasterService.generateAnswer({
                gameId: selectedGame,
                question: userMessage.content,
                context: undefined
            });

            const botMessage: Message = {
                id: (Date.now() + 1).toString(),
                type: 'bot',
                content: response.answer,
                timestamp: new Date(),
                response
            };

            setMessages(prev => [...prev, botMessage]);
        } catch (error) {
            console.error('ÎãµÎ≥Ä ÏÉùÏÑ± Ïã§Ìå®:', error);

            const errorMessage: Message = {
                id: (Date.now() + 1).toString(),
                type: 'bot',
                content: 'Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±ÌïòÎäî Ï§ëÏóê Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
                timestamp: new Date()
            };

            setMessages(prev => [...prev, errorMessage]);
        } finally {
            setIsLoading(false);
        }
    };

    const handleFeedback = (messageId: string, feedbackType: UserFeedback['type'], comment?: string) => {
        const feedback: UserFeedback = {
            type: feedbackType,
            timestamp: new Date(),
            comment
        };

        // Î©îÏãúÏßÄÏóê ÌîºÎìúÎ∞± Ï∂îÍ∞Ä
        setMessages(prev => prev.map(msg => 
            msg.id === messageId 
                ? { ...msg, feedback }
                : msg
        ));

        // ÌîºÎìúÎ∞± ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const message = messages.find(m => m.id === messageId);
        if (message?.response) {
            updateFeedbackStats(feedbackType, message.response.confidence);
        }

        // ÌîºÎìúÎ∞± Îç∞Ïù¥ÌÑ∞ Î°úÍπÖ (Î∂ÑÏÑùÏö©)
        logFeedbackData(messageId, feedbackType, comment, message?.response?.confidence || 0);

        console.log('üìä [ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞± ÏàòÏßë]', {
            Î©îÏãúÏßÄID: messageId,
            ÌîºÎìúÎ∞±ÌÉÄÏûÖ: feedbackType,
            Ïã†Î¢∞ÎèÑ: message?.response?.confidence,
            ÏΩîÎ©òÌä∏: comment
        });
    };

    const updateFeedbackStats = (feedbackType: UserFeedback['type'], confidence: number) => {
        const newStats = { ...feedbackStats };
        newStats.totalFeedbacks += 1;
        
        switch (feedbackType) {
            case 'accurate':
                newStats.accurateCount += 1;
                break;
            case 'inaccurate':
                newStats.inaccurateCount += 1;
                break;
            case 'need_more':
                newStats.needMoreCount += 1;
                break;
        }

        // ÌèâÍ∑† Ïã†Î¢∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
        newStats.averageConfidence = (
            (newStats.averageConfidence * (newStats.totalFeedbacks - 1) + confidence) / 
            newStats.totalFeedbacks
        );

        saveFeedbackStats(newStats);
    };

    const logFeedbackData = (messageId: string, feedbackType: string, comment?: string, confidence: number = 0) => {
        // Ïã§Ï†ú Ïö¥ÏòÅÏóêÏÑúÎäî Î∂ÑÏÑù ÏÑúÎπÑÏä§Î°ú Ï†ÑÏÜ°
        const feedbackLog = {
            messageId,
            feedbackType,
            comment,
            confidence,
            gameId: selectedGame,
            timestamp: new Date().toISOString(),
            sessionId: 'session_' + Date.now(), // Ïã§Ï†úÎ°úÎäî Í≥†Ïú† ÏÑ∏ÏÖò ID ÏÇ¨Ïö©
        };

        // Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑúÎäî localStorageÏóê Ï†ÄÏû•
        const existingLogs = JSON.parse(localStorage.getItem('rule-master-feedback-logs') || '[]');
        existingLogs.push(feedbackLog);
        localStorage.setItem('rule-master-feedback-logs', JSON.stringify(existingLogs));

        console.log('üìà [ÌîºÎìúÎ∞± Î°úÍ∑∏]', feedbackLog);
    };

    const handleKeyPress = (e: React.KeyboardEvent) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSendMessage();
        }
    };

    const formatTime = (date: Date) => {
        return date.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit'
        });
    };

    return (
        <div className="flex flex-col h-full max-w-4xl mx-auto p-4 space-y-4">
            {/* Ìó§Îçî */}
            <Card>
                <CardHeader className="pb-3">
                    <CardTitle className="flex items-center gap-2">
                        <Bot className="w-5 h-5" />
                        Î≥¥ÎìúÍ≤åÏûÑ Î£∞ ÎßàÏä§ÌÑ∞
                        {feedbackStats.totalFeedbacks > 0 && (
                            <Badge variant="secondary" className="ml-2">
                                ÎßåÏ°±ÎèÑ: {Math.round((feedbackStats.accurateCount / feedbackStats.totalFeedbacks) * 100)}%
                            </Badge>
                        )}
                    </CardTitle>
                    <div className="flex items-center gap-4">
                        <Select
                            value={selectedGame?.toString() || ""}
                            onValueChange={(value) => handleGameSelection(value ? parseInt(value) : null)}
                        >
                            <SelectTrigger className="w-64">
                                <SelectValue placeholder="Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî" />
                            </SelectTrigger>
                            <SelectContent>
                                {availableGames.map(game => (
                                    <SelectItem key={game.id} value={game.id.toString()}>
                                        {game.name}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>

                        {selectedGame && (
                            <Badge variant="secondary">
                                {availableGames.find(g => g.id === selectedGame)?.name} ÏÑ†ÌÉùÎê®
                            </Badge>
                        )}
                    </div>
                </CardHeader>
            </Card>

            {/* ÎÖÑÎèÑ Í≤ΩÍ≥† ÌëúÏãú */}
            {yearInfo.publishedYear && (
                <YearWarningDisplay
                    gameName={selectedGameName}
                    publishedYear={yearInfo.publishedYear}
                    isVisible={showYearWarning}
                    onDismiss={() => setShowYearWarning(false)}
                />
            )}

            {/* Î©îÏãúÏßÄ ÏòÅÏó≠ */}
            <div className="flex-1 overflow-y-auto space-y-4 min-h-96">
                {messages.map((message) => (
                    <div key={message.id} className="space-y-2">
                        <MessageBubble message={message} />
                        {message.response && (
                            <ResponseDetails 
                                response={message.response} 
                                messageId={message.id}
                                feedback={message.feedback}
                                onFeedback={handleFeedback}
                            />
                        )}
                    </div>
                ))}

                {isLoading && (
                    <div className="flex items-center gap-2 text-muted-foreground">
                        <Bot className="w-4 h-4 animate-pulse" />
                        <span>ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ± Ï§ëÏûÖÎãàÎã§...</span>
                    </div>
                )}
            </div>

            {/* ÏûÖÎ†• ÏòÅÏó≠ */}
            <Card>
                <CardContent className="p-4">
                    <div className="flex gap-2">
                        <Input
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={handleKeyPress}
                            placeholder={selectedGame
                                ? `${availableGames.find(g => g.id === selectedGame)?.name} Î£∞Ïóê ÎåÄÌï¥ ÏßàÎ¨∏ÌïòÏÑ∏Ïöî...`
                                : "Í≤åÏûÑÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Î£∞Ïóê ÎåÄÌï¥ ÏßàÎ¨∏ÌïòÏÑ∏Ïöî..."
                            }
                            disabled={isLoading}
                            className="flex-1"
                        />
                        <Button
                            onClick={handleSendMessage}
                            disabled={isLoading || !input.trim()}
                            size="icon"
                        >
                            <Send className="w-4 h-4" />
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </div>
    );
}

function MessageBubble({ message }: { message: Message }) {
    return (
        <div className={`flex gap-3 ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}>
            {message.type === 'bot' && (
                <div className="w-8 h-8 rounded-full bg-primary flex items-center justify-center flex-shrink-0">
                    <Bot className="w-4 h-4 text-primary-foreground" />
                </div>
            )}

            <div className={`max-w-[80%] space-y-1`}>
                <div className={`rounded-lg p-3 ${message.type === 'user'
                        ? 'bg-primary text-primary-foreground ml-auto'
                        : 'bg-muted'
                    }`}>
                    <p className="whitespace-pre-wrap">{message.content}</p>
                </div>
                <p className={`text-xs text-muted-foreground ${message.type === 'user' ? 'text-right' : 'text-left'
                    }`}>
                    {formatTime(message.timestamp)}
                </p>
            </div>

            {message.type === 'user' && (
                <div className="w-8 h-8 rounded-full bg-secondary flex items-center justify-center flex-shrink-0">
                    <User className="w-4 h-4" />
                </div>
            )}
        </div>
    );
}

function ResponseDetails({ 
    response, 
    messageId, 
    feedback, 
    onFeedback 
}: { 
    response: RuleMasterResponse;
    messageId: string;
    feedback?: UserFeedback;
    onFeedback: (messageId: string, feedbackType: UserFeedback['type'], comment?: string) => void;
}) {
    return (
        <div className="ml-11 space-y-3">
            {/* Ïã†Î¢∞ÎèÑ Î∞è ÌîºÎìúÎ∞± Î≤ÑÌäº */}
            <div className="flex items-center gap-2 justify-between">
                <div className="flex items-center gap-2">
                    <Badge variant={response.confidence > 70 ? 'default' : 'secondary'}>
                        Ïã†Î¢∞ÎèÑ: {response.confidence}%
                    </Badge>
                    {response.sources.map((source, idx) => (
                        <Badge key={idx} variant="outline" className="text-xs">
                            <BookOpen className="w-3 h-3 mr-1" />
                            {source}
                        </Badge>
                    ))}
                </div>

                {/* ÌîºÎìúÎ∞± Î≤ÑÌäº */}
                {!feedback ? (
                    <div className="flex items-center gap-1">
                        <span className="text-xs text-muted-foreground mr-2">ÎèÑÏõÄÏù¥ ÎêòÏóàÎÇòÏöî?</span>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => onFeedback(messageId, 'accurate')}
                            className="h-8 px-2"
                        >
                            <ThumbsUp className="w-4 h-4 text-green-600" />
                        </Button>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => onFeedback(messageId, 'inaccurate')}
                            className="h-8 px-2"
                        >
                            <ThumbsDown className="w-4 h-4 text-red-600" />
                        </Button>
                        <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => onFeedback(messageId, 'need_more')}
                            className="h-8 px-2"
                        >
                            <HelpCircle className="w-4 h-4 text-blue-600" />
                        </Button>
                    </div>
                ) : (
                    <div className="flex items-center gap-2">
                        <Badge variant="outline" className="text-xs">
                            {feedback.type === 'accurate' && 'üëç ÎèÑÏõÄÎê®'}
                            {feedback.type === 'inaccurate' && 'üëé Î∂ÄÏ†ïÌôï'}
                            {feedback.type === 'need_more' && '‚ùì Îçî ÌïÑÏöî'}
                        </Badge>
                        <span className="text-xs text-muted-foreground">ÌîºÎìúÎ∞± Í∞êÏÇ¨Ìï©ÎãàÎã§!</span>
                    </div>
                )}
            </div>

            {/* Í¥ÄÎ†® Ïö©Ïñ¥ */}
            {response.relatedTerms.length > 0 && (
                <Card className="bg-background/50">
                    <CardHeader className="pb-2">
                        <CardTitle className="text-sm flex items-center gap-2">
                            <BookOpen className="w-4 h-4" />
                            Í¥ÄÎ†® Ïö©Ïñ¥
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                        {response.relatedTerms.slice(0, 5).map((term, idx) => (
                            <div key={idx} className="flex items-start gap-2">
                                <Badge variant={term.isSpecific ? 'default' : 'secondary'} className="text-xs">
                                    {term.isSpecific ? 'ÌäπÌôî' : 'Í≥µÌÜµ'}
                                </Badge>
                                <div className="flex-1 text-sm">
                                    <span className="font-medium">{term.korean}</span>
                                    <span className="text-muted-foreground"> ({term.english})</span>
                                    {term.description && (
                                        <p className="text-xs text-muted-foreground mt-1">{term.description}</p>
                                    )}
                                </div>
                            </div>
                        ))}
                    </CardContent>
                </Card>
            )}

            {/* Ï†úÏïàÏÇ¨Ìï≠ */}
            {response.suggestions && response.suggestions.length > 0 && (
                <Card className="bg-blue-50/50 dark:bg-blue-950/20">
                    <CardContent className="p-3">
                        <div className="flex items-start gap-2">
                            <Lightbulb className="w-4 h-4 text-blue-600 flex-shrink-0 mt-0.5" />
                            <div className="space-y-1">
                                <p className="text-sm font-medium text-blue-900 dark:text-blue-100">Ï†úÏïà</p>
                                <ul className="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                                    {response.suggestions.map((suggestion, idx) => (
                                        <li key={idx}>‚Ä¢ {suggestion}</li>
                                    ))}
                                </ul>
                            </div>
                        </div>
                    </CardContent>
                </Card>
            )}
        </div>
    );
}

function formatTime(date: Date) {
    return date.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit'
    });
} 
name: RAG System Evaluation

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (UTC) ì‹¤í–‰
  schedule:
    - cron: '0 9 * * *'
  
  # Pull Request ìƒì„± ì‹œ ì‹¤í–‰
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/app/api/chat/**'
      - 'scripts/**'
      - 'supabase/migrations/**'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      max_questions:
        description: 'í‰ê°€í•  ìµœëŒ€ ì§ˆë¬¸ ìˆ˜'
        required: false
        default: '20'
        type: string
      game_id:
        description: 'ê²Œì„ ID'
        required: false
        default: 'ARK_NOVA'
        type: string

# í™˜ê²½ ë³€ìˆ˜
env:
  NODE_VERSION: '18'
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}

jobs:
  evaluate-rag:
    runs-on: ubuntu-latest
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ì»¤ë°‹ í•´ì‹œìš©)
    
    # 2. Node.js ì„¤ì •
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install dependencies
      run: |
        npm ci
        npm install autoevals dotenv
    
    # 4. Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    - name: Build Next.js application
      run: npm run build
    
    # 5. Next.js ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
    - name: Start Next.js server
      run: |
        npm start &
        echo "NEXT_PID=$!" >> $GITHUB_ENV
        # ì„œë²„ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
        timeout 60 bash -c 'until curl -f http://localhost:3000/api/chat; do sleep 2; done'
      env:
        PORT: 3000
    
    # 6. ì„œë²„ ìƒíƒœ í™•ì¸
    - name: Check server health
      run: |
        curl -f http://localhost:3000/api/chat || exit 1
        echo "âœ… Next.js ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
    
    # 7. RAG ì‹œìŠ¤í…œ í‰ê°€ ì‹¤í–‰
    - name: Run RAG evaluation
      id: evaluation
      run: |
        cd scripts
        node evaluate-rag.js
      env:
        NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
        MAX_QUESTIONS: ${{ github.event.inputs.max_questions || '20' }}
        GAME_ID: ${{ github.event.inputs.game_id || 'ARK_NOVA' }}
    
    # 8. í‰ê°€ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì €ì¥
    - name: Upload evaluation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results-${{ github.sha }}
        path: |
          scripts/evaluation-*.json
          scripts/evaluation-*.log
        retention-days: 30
    
    # 9. Next.js ì„œë²„ ì¢…ë£Œ
    - name: Stop Next.js server
      if: always()
      run: |
        if [ ! -z "$NEXT_PID" ]; then
          kill $NEXT_PID || true
        fi
        pkill -f "next start" || true
    
    # 10. í‰ê°€ ê²°ê³¼ ìš”ì•½ (PR ì½”ë©˜íŠ¸ìš©)
    - name: Generate evaluation summary
      if: github.event_name == 'pull_request'
      id: summary
      run: |
        # Supabaseì—ì„œ ìµœì‹  í‰ê°€ ê²°ê³¼ ì¡°íšŒ
        SUMMARY=$(node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
          
          (async () => {
            const { data } = await supabase
              .from('evaluation_results')
              .select('*')
              .eq('commit_hash', process.env.GITHUB_SHA)
              .order('created_at', { ascending: false })
              .limit(1)
              .single();
            
            if (data) {
              console.log('## ğŸ¤– RAG ì‹œìŠ¤í…œ í‰ê°€ ê²°ê³¼');
              console.log('');
              console.log('| ì§€í‘œ | ì ìˆ˜ | ìƒíƒœ |');
              console.log('|------|------|------|');
              console.log('| Faithfulness | ' + (data.faithfulness_score * 100).toFixed(1) + '% | ' + (data.faithfulness_score >= 0.7 ? 'âœ…' : 'âŒ') + ' |');
              console.log('| Answer Relevancy | ' + (data.answer_relevancy_score * 100).toFixed(1) + '% | ' + (data.answer_relevancy_score >= 0.8 ? 'âœ…' : 'âŒ') + ' |');
              console.log('| Context Recall | ' + (data.context_recall_score * 100).toFixed(1) + '% | ' + (data.context_recall_score >= 0.6 ? 'âœ…' : 'âŒ') + ' |');
              console.log('| Context Precision | ' + (data.context_precision_score * 100).toFixed(1) + '% | ' + (data.context_precision_score >= 0.7 ? 'âœ…' : 'âŒ') + ' |');
              console.log('');
              console.log('**í‰ê°€ ìƒì„¸:**');
              console.log('- í‰ê°€ëœ ì§ˆë¬¸ ìˆ˜: ' + data.total_questions_evaluated);
              console.log('- í‰ê·  ì‘ë‹µ ì‹œê°„: ' + data.average_response_time_ms + 'ms');
              console.log('- ì»¤ë°‹: ' + data.commit_hash.substring(0, 7));
              console.log('- ë¸Œëœì¹˜: ' + data.branch_name);
            } else {
              console.log('í‰ê°€ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
          })();
        ")
        
        echo "EVALUATION_SUMMARY<<EOF" >> $GITHUB_OUTPUT
        echo "$SUMMARY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    # 11. PRì— í‰ê°€ ê²°ê³¼ ì½”ë©˜íŠ¸ ì¶”ê°€
    - name: Comment PR with evaluation results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const summary = `${{ steps.summary.outputs.EVALUATION_SUMMARY }}`;
          
          if (summary && summary.trim()) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          }

  # ì„±ëŠ¥ ì €í•˜ ì•Œë¦¼ ì‘ì—…
  performance-alert:
    runs-on: ubuntu-latest
    needs: evaluate-rag
    if: always() && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install @supabase/supabase-js
    
    # ì„±ëŠ¥ ì €í•˜ í™•ì¸ ë° ì•Œë¦¼
    - name: Check performance degradation
      run: |
        node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabase = createClient(process.env.NEXT_PUBLIC_SUPABASE_URL, process.env.SUPABASE_SERVICE_ROLE_KEY);
          
          (async () => {
            // ìµœê·¼ 2ê°œ í‰ê°€ ê²°ê³¼ ì¡°íšŒ
            const { data } = await supabase
              .from('evaluation_results')
              .select('*')
              .order('created_at', { ascending: false })
              .limit(2);
            
            if (data && data.length >= 2) {
              const [latest, previous] = data;
              const alerts = [];
              
              // ì„±ëŠ¥ ì €í•˜ ì„ê³„ê°’ (5% ì´ìƒ ê°ì†Œ)
              const degradationThreshold = 0.05;
              
              const metrics = [
                { name: 'Faithfulness', current: latest.faithfulness_score, previous: previous.faithfulness_score, threshold: 0.7 },
                { name: 'Answer Relevancy', current: latest.answer_relevancy_score, previous: previous.answer_relevancy_score, threshold: 0.8 },
                { name: 'Context Recall', current: latest.context_recall_score, previous: previous.context_recall_score, threshold: 0.6 },
                { name: 'Context Precision', current: latest.context_precision_score, previous: previous.context_precision_score, threshold: 0.7 }
              ];
              
              for (const metric of metrics) {
                // ì„ê³„ê°’ ë¯¸ë‹¬ í™•ì¸
                if (metric.current < metric.threshold) {
                  alerts.push('ğŸš¨ ' + metric.name + ' ì ìˆ˜ê°€ ì„ê³„ê°’(' + (metric.threshold * 100) + '%)ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤: ' + (metric.current * 100).toFixed(1) + '%');
                }
                
                // ì„±ëŠ¥ ì €í•˜ í™•ì¸
                const degradation = previous - metric.current;
                if (degradation > degradationThreshold) {
                  alerts.push('ğŸ“‰ ' + metric.name + ' ì ìˆ˜ê°€ ' + (degradation * 100).toFixed(1) + '%p ê°ì†Œí–ˆìŠµë‹ˆë‹¤: ' + (previous * 100).toFixed(1) + '% â†’ ' + (metric.current * 100).toFixed(1) + '%');
                }
              }
              
              if (alerts.length > 0) {
                console.log('PERFORMANCE_ALERTS=true');
                console.log('ALERT_MESSAGE=' + alerts.join('\\n'));
                process.exit(1); // ì•Œë¦¼ì„ ìœ„í•´ ì‹¤íŒ¨ ìƒíƒœë¡œ ì¢…ë£Œ
              } else {
                console.log('âœ… ì„±ëŠ¥ ì €í•˜ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
            } else {
              console.log('âš ï¸ ë¹„êµí•  ì´ì „ í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
          })();
        "
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    
    # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    - name: Send Slack notification
      if: failure() && env.PERFORMANCE_ALERTS == 'true'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ğŸš¨ **RAG ì‹œìŠ¤í…œ ì„±ëŠ¥ ì €í•˜ ê°ì§€**
          
          ${{ env.ALERT_MESSAGE }}
          
          **ìƒì„¸ ì •ë³´:**
          - Repository: ${{ github.repository }}
          - Branch: ${{ github.ref_name }}
          - Commit: ${{ github.sha }}
          - Workflow: ${{ github.workflow }}
          
          [í‰ê°€ ê²°ê³¼ í™•ì¸í•˜ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true

# ì›Œí¬í”Œë¡œìš° ê¶Œí•œ
permissions:
  contents: read
  pull-requests: write
  actions: read